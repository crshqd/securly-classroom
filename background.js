const e="https://deviceconsole.securly.com";const t=chrome.runtime.getManifest().version;const s=chrome.runtime.getManifest().manifest_version;const n="/chrome/handle";const o="/chrome/fire";const i=200;const a=412;const r="chrome_app_list";const c="authenticate";const l="get_org_url";const u="chrome_hand_raised";const d="chrome_idle_status_change";const h="chrome_login";const m="chrome_lost_mode_on";const f="chrome_send_message";const g="chrome_call";const w="chrome_auth_confirm";const p="chrome_change_device_name";const y="chrome_change_server_url";const b="chrome_device_not_found";const v="chrome_get_location";const k="chrome_login_confirmation";const C="chrome_update_logging";const I="chrome_enable_lost_mode";const S="chrome_blocking_plan";const T="chrome_chat_message";const E="chrome_session";const U="chrome_session_update";const A="chrome_clear_raised_hand";const R="chrome_close_tab";const L="chrome_focus_tab";const _="chrome_get_tabs";const N="chrome_lock_screen";const O="chrome_open_site";const x="chrome_get_screenshot";const P="chrome_screen_share";const M="chrome_site_lock";const H="chrome_teacher_message";const q="chrome_teacher_screen_share";const D="chrome_unlock";const W="device not found";const B="chrome_upgrade";const F="blocklist";const J="lostModeType";const z="isChromeBook";const j="blockingPlanUrls";const G="blockingPlanName";const V="blockType";const X="deviceName";const Q="allowContactAdmin";const Y="allowCaptureScreen";const $="notificationInterval";const Z="orgName";const K="screenBlockMessage";const ee="serverUrl";const te="udid";const se="updateCheckDate";const ne="visitedUrls";const oe="whitelist";const ie="block";const ae="none";const re="Allow_only";const ce="Block_only";const le="repeatLogin";const ue="restartPolling";const de="restartForUpgrade";const he="sendUrls";const me="ping";const fe="showWarning";const ge="X-TabPilot-RegCode";const we=80*1e3;const pe=-1;const ye="session_start";const be="screen_sharing";const ve="Class session is active";const ke="update_available";const Ce="throttled";const Ie={};const Se=["accounts.google.com","accounts.youtube.com","canvaslms.com","instructure.com/login"];const Te=["classroom.google.com","docs.google.com","assignments.google.com"];const Ee=[e.replace("https://",""),"deviceconsole.securly.com","techpilotlabs.com"];const Ue=["chrome-extension://","/_/chrome/newtab"];var Ae=null;var Re=null;var Le=null;const _e=false;const Ne=true;const Oe="com.securly.classroom_native_host";const xe="handshake";const Pe="win_not_allowed";function Me(e){return new Promise(((t,s)=>{chrome.tabs.query(e,(function(e){if(chrome.runtime.lastError){console.log("Cannot get chrome tabs: "+chrome.runtime.lastError.message)}t(e)}))}))}function He(){return new Promise((e=>{chrome.windows.getAll({populate:true},(t=>{e(t)}))}))}async function qe(e){return new Promise(((t,s)=>{chrome.windows.get(e,(e=>{if(chrome.runtime.lastError){s(chrome.runtime.lastError.message)}else{t(e)}}))}))}function De(){return new Promise((e=>{chrome.windows.getLastFocused(null,(function(t){e(t)}))}))}function We(e){return new Promise((t=>{const s={focused:true,state:"normal",type:"normal"};if(e){s["url"]=e;if(Ae.maxOpenTabs>0&&e.length>Ae.maxOpenTabs){Ae.additionalOpenTabs=e.length-Ae.maxOpenTabs}}chrome.windows.create(s,(e=>{t(e)}))}))}async function Be(e){const t={focused:true,state:"fullscreen"};try{await Fe(e,t)}catch(e){console.log("Error while update to fullscreen: "+chrome.runtime.lastError.message)}}async function Fe(e,t){return new Promise(((s,n)=>{chrome.windows.update(e,t,(function(e){if(chrome.runtime.lastError){n(chrome.runtime.lastError.message)}else{s()}}))}))}async function Je(e){return new Promise(((t,s)=>{chrome.tabs.get(e,(function(e){if(chrome.runtime.lastError){s(chrome.runtime.lastError.message)}t(e)}))}))}function ze(e){return new Promise(((t,s)=>{chrome.tabs.create(e,(function(e){if(chrome.runtime.lastError){s(chrome.runtime.lastError.message)}else{t(e)}}))}))}function je(e){return new Promise(((t,s)=>{chrome.tabs.remove(e,(function(){if(chrome.runtime.lastError){console.log("Error closing tab: "+chrome.runtime.lastError.message)}t()}))}))}async function Ge(e){const t=await Je(e);if(t){try{const s=await qe(t.windowId);await Fe(s.id,{focused:true});await ot(e,{active:true})}catch(e){console.log("Error focusing tab: "+e)}}else{console.log("Not found tab with id="+e)}}function Ve(){return new Promise(((e,t)=>{chrome.tabs.captureVisibleTab((function(s){if(chrome.runtime.lastError){t(chrome.runtime.lastError.message)}if(typeof s==="undefined"){t("No screenshot captured")}e(s)}))}))}async function Xe(){return new Promise((e=>{chrome.storage.local.get(null,(function(t){if(chrome.runtime.lastError){console.log("Error loading config from storage: "+chrome.runtime.lastError.message);e(new ut({}))}e(new ut(t))}))}))}async function Qe(){return new Promise((e=>{chrome.storage.local.get(ne,(t=>{if(chrome.runtime.lastError){console.log("Failed to load urls from local storage");e()}else{e(t[ne])}}))}))}async function Ye(){if(typeof getSubstitutedEmail==="function"){return Promise.resolve(getSubstitutedEmail())}if(Ne&&chrome.identity){return new Promise((e=>{const t=function(e){return e&&e.trim().length>0?e:null};if(chrome.declarativeNetRequest){chrome.identity.getProfileUserInfo({accountStatus:"ANY"},(function(s){e(t(s["email"]))}))}else{chrome.identity.getProfileUserInfo((function(s){e(t(s["email"]))}))}}))}else{return Promise.resolve(null)}}async function $e(){return new Promise(((e,t)=>{if(chrome.enterprise&&chrome.enterprise.deviceAttributes){chrome.enterprise.deviceAttributes.getDirectoryDeviceId((function(t){console.log("Start with requested directory device ID="+t);e(t)}))}else{e(null)}}))}async function Ze(){return new Promise(((e,t)=>{if(chrome.enterprise&&chrome.enterprise.deviceAttributes){chrome.enterprise.deviceAttributes.getDeviceSerialNumber((function(t){e(t)}))}else{e(null)}}))}function Ke(){return new Promise((e=>{chrome.alarms.clearAll((t=>{if(!t){console.log("Alarms not cleared");if(chrome.runtime.lastError){console.log("Alarms clear error: "+chrome.runtime.lastError.message)}}else{console.log("All alarms cleared")}e()}))}))}async function et(e,t){try{await tt(e,t)}catch(s){const n="Could not establish connection. Receiving end does not exist";if(s.indexOf(n)!==-1){await nt(e);await tt(e,t)}else{throw s}}}function tt(e,t){return new Promise(((s,n)=>{chrome.tabs.sendMessage(e,t,(async function(e){if(chrome.runtime.lastError){n(chrome.runtime.lastError.message)}else{s()}}))}))}function nt(e){return new Promise(((t,s)=>{chrome.tabs.executeScript(e,{file:"teacherTools.js",allFrames:false,runAt:"document_start"},(function(e){if(chrome.runtime.lastError){console.log("Failed to inject scripts");s(chrome.runtime.lastError.message)}else{t()}}))}))}function ot(e,t){if(!(typeof e==="number")){return Promise.resolve()}return new Promise(((s,n)=>{chrome.tabs.update(e,t,(function(){if(chrome.runtime.lastError){n(chrome.runtime.lastError.message)}else{s()}}))}))}function it(){return new Promise(((e,t)=>{const s={state:"fullscreen",type:"popup",focused:true,url:"blocking/block.html"};chrome.windows.create(s,(function(s){if(chrome.runtime.lastError){t(chrome.runtime.lastError.message)}else{e(s.id)}}))}))}function at(e){return new Promise(((t,s)=>{chrome.windows.remove(e,(function(){if(chrome.runtime.lastError){s(chrome.runtime.lastError.message)}else{t()}}))}))}async function rt(){return new Promise((e=>{navigator.geolocation.getCurrentPosition((t=>{const s=t.coords;const n={latitude:s.latitude,longitude:s.longitude,accuracy:s.accuracy};console.log("Lat: "+s.latitude.toFixed(4)+" Lon: "+s.longitude.toFixed(4));e(n)}),(t=>{console.log("Error: "+t.code+" "+t.message);const s={error:t.message};e(s)}),{maximumAge:6e5,timeout:2e4})}))}async function ct(e){return new Promise((t=>{chrome.alarms.get(e,(e=>{t(e)}))}))}async function lt(e){return new Promise((t=>{chrome.alarms.clear(e,(s=>{console.log("Alarm '"+e+(s?"' was cleared":"' was not cleared"));t()}))}))}"use strict";class ut{constructor(t){this.items=t;this._defaultBlockMessage="Your device is blocked";this.directoryDeviceId=null;this._pingCount=0;this.isLoggedIn=false;this.announce=null;this.sessionId=null;this.activeClassNames=[];this.studentId=null;this.studentName=null;this.canRaiseHand=false;this.isHandRaised=false;this.tabListenersAdded=false;this.chatMessages=[];this.hasUnreadChatMessages=false;this.canStartChat=false;this.playChatAlert=false;this.closeTabsTimeout=null;this.lockedToCourseWorkResources=false;this.canvasAssignmentIds=[];this.maxOpenTabs=0;this.additionalOpenTabs=0;this.activeTabId=null;this.userEmail=null;this.teacherId=null;this.teacherName=null;this.conferenceUrl=null;this.blockWindowId=0;this.loginErrorReason=null;this.shareScreenHandler=null;this.capturedScreen=null;if(!t[ee]){this.items[ee]=e}if(!t[K]){this.items[K]=this._defaultBlockMessage}if(!t[J]){this.items[J]=_e?ie:ae}if(!t[$]){this.items[$]=0}if(!t[Y]){this.items[Y]=false}if(!t[Q]){this.items[Q]=false}if(!t[z]){this.items[z]=false}if(!t[se]){this.items[se]=new Date("01 Jan 1970 00:00:00 GMT").getTime()}}updateClassSessionState(e){this.sessionId=!!e["sessionId"]?e["sessionId"]:null;this.canRaiseHand=!!e["allowHandRaise"];this.announce=null;this.hasUnreadChatMessages=false;this.chatMessages=!!e["chatMessages"]?e["chatMessages"]:[];this.canStartChat=!!e["canStartChat"];this.playChatAlert=!!e["playChatAlertToStudent"];this.maximizeFocusedWindow=!!e["maximizeFocused"];this.maxOpenTabs=typeof parseInt(e["maxOpenTabs"])==="number"?parseInt(e["maxOpenTabs"]):0;this.additionalOpenTabs=0;this.activeClassNames=!!e["activeClassNames"]?e["activeClassNames"]:[]}get serverUrl(){return this.items[ee]}saveServerUrl(e){return this.store(ee,e)}get orgBlocklist(){return this.items[F]}async saveOrgBlocklist(e){await this.store(F,e);await this.store(oe,null)}get blockingPlanUrls(){return this.items[j]}get blockingPlanName(){return this.items[G]}get blockingPlanType(){return this.items[V]}async saveBlockingPlan(e,t,s){await this.store(j,e);await this.store(G,t);await this.store(V,s)}get blockedModeType(){return this.items[J]}saveBlockedModeType(e){return this.store(J,e)}get blockedText(){return this.items[K]?this.items[K]:this._defaultBlockMessage}get deviceName(){return this.items[X]}saveDeviceName(e){return this.store(X,e)}get deviceUdid(){return this.items[te]}saveDeviceUdid(e){return this.store(te,e)}get isChromeBook(){return this.items[z]}saveIsChromeBook(e){return this.store(z,e)}get isChatActive(){return this.chatMessages.length>0}get isClassSessionActive(){return this.sessionId!=null}get isObservationActive(){return this.sessionId!=null||this.activeClassNames.length>0}get isContactAdminAllowed(){return this.items[Q]}get isScreenLocked(){return this.items[J]===ie}get isScreenCaptureAllowed(){return this.items[Y]}get isSiteLocked(){return!!this.items[oe]}get notificationInterval(){return this.items[$]}get orgName(){return this.items[Z]}get pingCount(){return this._pingCount++}get updateCheckDate(){return new Date(parseInt(this.items[se]))}async saveUpdateCheckDate(e){return this.store(se,e.getTime())}get whitelist(){if(this.items[oe]){return this.items[oe]}return this.items[V]===re?this.items[j]:null}async saveWhitelist(e){await this.store(oe,e)}async clearWhitelist(){this.lockedToCourseWorkResources=false;await this.store(oe,null)}async saveBlockedInfo(e,t,s,n,o){let i={};if(e){i[K]=e;this.items[K]=e}else{i[K]=this._defaultBlockMessage;this.items[K]=this._defaultBlockMessage}if(t){i[J]=t;this.items[J]=t}let a="Stored screen block modeType: "+t+", message: "+e;if(typeof n!=="undefined"){i[Y]=n;this.items[Y]=n;a+=", capture screen: "+n}if(typeof o!=="undefined"){i[Q]=o;this.items[Q]=o;a+=", allow contact admin: "+o}a+=", notification interval: ";if(typeof n!=="undefined"&&s!==pe){i[$]=s;this.items[$]=s;a+=s}console.log(a);return this.bulkStore(i)}async saveDeviceInfo(e,t,s,n,o,i,a){let r={};r[Z]=e;this.items[Z]=e;r[X]=t;this.items[X]=t;r[J]=s;this.items[J]=s;r[K]=n;this.items[K]=n;r[$]=o;this.items[$]=o;r[Q]=i;this.items[Q]=i;r[Y]=a;this.items[Y]=a;return this.bulkStore(r)}store(e,t){if(t){this.items[e]=t;return new Promise((s=>{chrome.storage.local.set({[e]:t},(function(){if(chrome.runtime.lastError){console.log("Failed to save object "+JSON.stringify(t)+" for key '"+e+"'. Error is: "+chrome.runtime.lastError.message)}else{console.log("Stored "+JSON.stringify(t)+" for key: "+e)}s()}))}))}else{delete this.items[e];return new Promise((t=>{chrome.storage.local.remove([e],(function(){if(chrome.runtime.lastError){console.log("Failed to remove key '"+e+"'. Error is: "+chrome.runtime.lastError.message)}else{console.log("Key '"+e+"' removed")}t()}))}))}}bulkStore(e){return new Promise((t=>{chrome.storage.local.set(e,(function(){if(chrome.runtime.lastError){console.log("Failed to bulk save '"+JSON.stringify(e)+"'. Error is: "+chrome.runtime.lastError.message)}else{console.log("Items "+JSON.stringify(e)+" saved")}t()}))}))}bulkDelete(e){return new Promise((t=>{chrome.storage.local.remove(e,(function(){if(chrome.runtime.lastError){console.log("Failed to remove keys "+e+" Error is: "+chrome.runtime.lastError.message)}else{console.log("Keys "+e+" removed")}t()}))}))}}const st=async function(){chrome.alarms.clearAll();if(typeof cs==="function"){cs()}if(Ne){Re=new Mt;await Re.noActiveClassIcon();Ae=await Xe()}else{Ae=new ut({})}Le=new ht(Ae.serverUrl);Ae.userEmail=await Ye();if(_e){requestBlockScreen(Ae.blockedText,Ae.blockedModeType,Ae.notificationInterval,Ae.isScreenCaptureAllowed,Ae.isContactAdminAllowed);updateVersion()}if(Ne){const e=await Qe();console.log("INIT URL STORAGE WITH URLS="+JSON.stringify(e));_s=new Pt(e)}await dt();await kt()};async function dt(){const directoryDeviceId=await $e();if(directoryDeviceId){Ae.directoryDeviceId=directoryDeviceId;await Ae.saveIsChromeBook(true)}else if(typeof substituteDeviceId==="function"){substituteDeviceId()}}const stp=function(){console.log("Stopping the app");chrome.alarms.clearAll()};chrome.runtime.onSuspend.addListener((function(){console.log("App suspended")}));"use strict";class ht{constructor(e){this.url=e;console.log("Router initialized for "+this.url);this.queue=[];this.isSending=false}static getAck(e){if(e){if(e["requestType"]===b){throw W}return{seq:e["seq"],response:e["requestType"]}}else{return{}}}updateUrl(e){this.url=e;console.log("Router url updated="+this.url)}async sendCommand(e){Object.assign(e,{version:t,udid:Ae.deviceUdid,command:"ack"});this.queue.push(e);return await this.processQueue()}cleanSent(){this.queue=this.queue.filter((e=>!e["sent"]))}cleanQueue(){this.queue.splice(0,this.queue.length)}async processQueue(){let e=false;if(this.isSending){return true}this.cleanSent();this.isSending=true;try{for(const e of this.queue){console.log("Sending command="+JSON.stringify(e));await this.send(e,o);console.info("Command "+JSON.stringify(e)+" sent successfully");e["sent"]=true}e=true}catch(t){console.log("Failed to send command. Error="+t);e=false}finally{this.isSending=false;this.cleanSent()}return e}async readCommands(e){Object.assign(e,{version:t,udid:Ae.deviceUdid,command:"ack"});if(this.queue.length>0){await this.processQueue()}console.log("Sending ack="+JSON.stringify(e));return await this.send(e,n)}async send(e,t){return new Promise(((s,n)=>{const o=new XMLHttpRequest;o.timeout=we;o.upload.addEventListener("error",(function(e){n("XHR: Error in request upload")}));o.ontimeout=function(){n("XHR: Request timeout")};o.open("POST",this.url+t);o.setRequestHeader(ge,e["udid"]);o.setRequestHeader("Content-Type","application/json; charset=UTF-8");o.onreadystatechange=async function(){if(this.readyState===XMLHttpRequest.DONE){switch(this.status){case i:if(this.responseText&&this.responseText.length>0){try{const e=JSON.parse(this.responseText);s(e)}catch(e){let t=this.responseText.length>200?this.responseText.substr(0,200)+"...":this.responseText;n("XHR: Received incorrect response="+t)}}else{s()}break;case 0:n("Status 0");break;case a:n(B);break;default:n("XHR: Server responded with http status="+this.status)}}};o.send(JSON.stringify(e))}))}}async function mt(e){const t=Ie[e["requestType"]];if(typeof t!=="undefined"){return t(e)}else{console.log("Got unknown message: "+e["requestType"])}}async function ft(e){if(!e){return Promise.resolve()}console.log("Process server commands: "+JSON.stringify(e));let t=e["commands"];if(t&&t.length>0){return t.reduce(((e,t)=>e.then(mt(t))),Promise.resolve())}else{return mt(e)}}async function gt(e){let t=e["commands"];if(t&&t.length>0){return{responses:t.map((e=>ht.getAck(e)))}}else if(e["requestType"]){return{responses:[ht.getAck(e)]}}return{responses:[]}}async function wt(){console.log("Long polling started");if(Ne){chrome.alarms.create(he,{periodInMinutes:1})}const e=3;let t=0;let s=null;let n=true;while(n){try{if(!s){s=ht.getAck()}const e=await Le.readCommands(s);if(e){s=await gt(e).catch((()=>{n=false}));ft(e).catch((t=>{if(Ot(t,W)){n=false}else{console.log("Failed to process action for one of responses:"+e+" error: "+t)}}))}else{s=null}}catch(s){if(!Ae.isLoggedIn){chrome.alarms.create(le,{delayInMinutes:1});console.log("Not logged in. Repeat login in 1 minute. Error: "+s);n=false}else if(s===B){n=false;await Ys()}else{t+=1;if(t>=e){chrome.alarms.create(ue,{delayInMinutes:1});console.log("Schedule server polling restart due to error="+s);n=false}console.log("Error #"+t+" while polling="+s)}}}console.log("Long polling stopped");chrome.alarms.clear(he)}chrome.alarms.onAlarm.addListener(pt);function pt(e){console.log("Fired alarm "+e.name);switch(e.name){case fe:if(!Ae.isScreenLocked){requestBlockScreen(Ae.blockedText,Ae.blockedModeType,pe,Ae.isScreenCaptureAllowed,Ae.isContactAdminAllowed)}break;case le:kt();break;case me:if(typeof un!=="undefined"){yt()}break;case he:bt();break;case de:chrome.runtime.reload();break;case ue:chrome.alarms.clear(ue);wt();break;default:console.log("Cannot process alarm")}}function yt(){const e="/agent/chrome/debug";const t=new XMLHttpRequest;const s="Ping "+Ae.pingCount;const n=Ae.serverUrl+e;t.open("POST",n);t.setRequestHeader(ge,Ae.deviceUdid);t.setRequestHeader("Content-Type","application/json; charset=UTF-8");const o={udid:Ae.deviceUdid,logString:s,logNum:un.logCount,logSource:"extension"};t.send(JSON.stringify(o));un.logCount+=1}async function bt(){if(!_s.hasUrls()){return}if(bt.isSending){return}bt.isSending=true;if(Ae.isClassSessionActive){await qs()}const e={udid:Ae.deviceUdid,urls:_s.getUrls(),timestamp:Date.now()};try{await vt(e);console.log("Urls sent successfully");_s.purge()}catch(e){console.log("Error while sending urls: "+e)}finally{bt.isSending=false}}async function vt(e){return new Promise(((t,s)=>{const n="/agent/chrome/url";const o=new XMLHttpRequest;const i="Failed to send urls to the server: ";o.timeout=we;o.upload.addEventListener("error",(function(e){s(i)}));o.ontimeout=function(){s(i+"Request timeout")};o.onreadystatechange=function(){if(this.readyState===XMLHttpRequest.DONE){if(this.status===200){t()}else if(this.status===0||this.status>=400){s("Failed to send urls to the server: "+this.status)}}};const a=Ae.serverUrl+n;o.open("POST",a);o.setRequestHeader(ge,Ae.deviceUdid);o.setRequestHeader("Content-Type","application/json; charset=UTF-8");o.send(JSON.stringify(e))}))}async function kt(e){console.log("Initiate login at "+new Date);await Ke();Le.cleanQueue();try{await ft(await St());await ft(await Tt());if(!Ae.isChromeBook){const e=await vs();if(e){console.log("Windows agent is present. Terminating login");return}}const e=await Et();if(!e){console.log("Failed to login. Repeat in 1 minute");chrome.alarms.create(le,{periodInMinutes:1});return}if(Ne){chrome.browserAction.onClicked.removeListener(kt);chrome.runtime.onMessage.removeListener(ms)}if(typeof un!=="undefined"){un.logCount=0}Ae.pingCount=0;Ae.loginErrorReason=null;wt()}catch(t){if(Ot(t,W)){console.log("Failed to authenticate: "+t);console.log("Logout and login again to connect");if(e&&Ae.loginErrorReason&&Ae.loginErrorReason!==Pe){await It()}}else if(Ot(t,B)){console.log("Extension upgrade required");await Ys()}else{console.log("Failed to login: "+t);chrome.alarms.create(le,{periodInMinutes:1})}}}function Ct(){kt(true)}async function It(){const e=chrome.runtime.getURL("notfound.html");try{await ze({url:e})}catch(e){console.log("Cannot open not found page due to error: "+e)}}function St(){const s=Ae.serverUrl===e;const o=Ae.directoryDeviceId;console.log("Request server url="+s+" config.serverUrl="+Ae.serverUrl+" udid="+o);if(!s){return Promise.resolve()}const i={command:l,udid:o,kiosk:_e,userEmail:!_e?Ae.userEmail:"kiosk",version:t,userAgent:navigator.userAgent};console.log("Get org url message="+JSON.stringify(i));return Le.send(i,n)}async function Tt(){if(Ae.deviceUdid){return Promise.resolve()}const e={command:c,userEmail:Ae.userEmail,kiosk:_e,version:t,userAgent:navigator.userAgent};if(Ae.directoryDeviceId){e["udid"]=Ae.directoryDeviceId}else{e["byod"]=true}console.log("Send AUTHENTICATE="+JSON.stringify(e));return Le.send(e,n)}async function Et(){await Le.send({response:h,kiosk:_e,userEmail:!_e?Ae.userEmail:"kiosk",userAgent:navigator.userAgent,version:t,manifest:s,id:chrome.runtime.id,udid:Ae.deviceUdid,command:"ack"},o);return true}function Ut(e,t){Le.sendCommand({response:r,appList:e,userId:t})}function sm(e){const t={response:f,text:e};Le.sendCommand(t)}async function At(e,t){const s=typeof t["maxWidth"]!=="undefined"?t["maxWidth"]:0;const n=typeof t["maxHeight"]!=="undefined"?t["maxHeight"]:0;const o=await _t(e,s,n);let i=Lt(t["url"]);if(typeof t["tabUrl"]!=="undefined"){i+="&tabUrl="+encodeURIComponent(t["tabUrl"])}if(typeof t["tabTitle"]!=="undefined"){i+="&tabTitle="+encodeURIComponent(t["tabTitle"])}Rt(i,o)}async function Rt(e,t){return new Promise((s=>{let n=new XMLHttpRequest;n.timeout=we;n.upload.addEventListener("error",(function(t){console.log("Failed to upload screenshot to url="+e)}));n.ontimeout=function(){console.log("Timeout while uploading screenshot to url="+e)};n.open("POST",e);n.setRequestHeader(ge,Ae.deviceUdid);n.setRequestHeader("Content-Type","image/jpg");n.onreadystatechange=function(){if(this.readyState===XMLHttpRequest.DONE){if(this.status>=200&&this.status<400){console.log("Screenshot send complete to url="+e)}else{console.log("Status="+this.status+". Failed to upload screenshot to url="+e)}s(this.status!==204)}};n.send(t)}))}function Lt(e){let t=Ae.serverUrl+e;if(t.indexOf("uid=")!==-1){t+="&udid="+Ae.deviceUdid}else{t+="?udid="+Ae.deviceUdid}if(Ae.userEmail){t+="&userEmail="+encodeURIComponent(Ae.userEmail)}return t}function _t(e,t,s){return new Promise(((n,o)=>{if(t===0&&s===0){console.log("Image will not be resized");n(e)}else{let o=document.createElement("img");o.onload=function(i){const a=o.width;const r=o.height;const c=Math.min(t/a,1);const l=Math.min(s/r,1);let u;if(c!==0&&l!==0){u=c<l?c:l}else{u=c!==0?c:l}if(u===1){console.log("Image will not be resized");n(e)}n(Nt(o,u))};o.src=e}})).then((e=>fetch(e))).then((e=>e.blob()))}function Nt(e,t){const s=Math.ceil(Math.log(1/t)/Math.log(2));let n=document.createElement("canvas");let o=n.getContext("2d");o.imageSmoothingEnabled=true;o.imageSmoothingQuality="high";let i={width:e.width,height:e.height};for(let a=1;a<=s;a++){const s=t+(1-t)/(a*2);const r=Math.floor(e.width*s);const c=Math.floor(e.height*s);if(a===1){n.width=r;n.height=c;o.drawImage(e,0,0,r,c)}else{o.drawImage(n,0,0,i.width,i.height,0,0,r,c)}i={width:r,height:c}}let a=document.createElement("canvas");a.width=Math.floor(e.width*t);a.height=Math.floor(e.height*t);let r=a.getContext("2d");r.imageSmoothingEnabled=true;r.imageSmoothingQuality="high";r.drawImage(n,0,0,i.width,i.height,0,0,a.width,a.height);return a.toDataURL("image/jpeg")}function Ot(e,t){return typeof e==="string"&&e.toLowerCase().includes(t)}class xt{constructor(e,t,s=false){const n=new URL(e);this.domain=n.hostname;this.path=n.pathname.slice(0,1e3);this.tabTitle=typeof t==="string"?t.trim().slice(0,1e3):null;this.isBlocked=s;this.timestamp=Date.now()}}class Pt{constructor(e){this.urls=Array.isArray(e)?e:[];this.lastVisitedUrl=null}saveUrl(e){if(!this.isLast(e)){this.lastVisitedUrl=e;this.urls.push(e)}chrome.storage.local.set({[ne]:this.urls},(()=>{if(chrome.runtime.lastError){console.log("Failed to save urls to local storage"+". Error is: "+chrome.runtime.lastError.message)}}))}isLast(e){return this.lastVisitedUrl instanceof xt&&this.lastVisitedUrl.domain===e.domain&&this.lastVisitedUrl.path===e.path}hasUrls(){return this.urls.length>0}getUrls(){return this.urls}purge(){this.urls=[];this.lastVisitedUrl=null;chrome.storage.local.remove(ne,(()=>{if(chrome.runtime.lastError){console.log("Failed to clear urls from local storage: "+chrome.runtime.lastError.message)}else{Qe().then((e=>{if(typeof e!="undefined"){console.log("Failed to clear urls from local storage")}else{console.log("Urls cleared from local storage")}}))}}))}}chrome.runtime.onUpdateAvailable.addListener((function(e){if(Ne){console.log("Extension update available, will reload. Current version="+t);chrome.runtime.reload()}}));"use strict";class Mt{constructor(){this.active=false;this.sharesScreen=false;this.raisedHand=false}static get sessionIcon(){return"logo16.png"}static get noSessionIcon(){return"logo16mono.png"}static get handIcon(){return"hand.png"}static get dottedIcon(){return"logo16share.png"}async activeClassIcon(){this.active=true;await this.setIcon(this.selectIcon())}async noActiveClassIcon(){this.active=false;await this.setIcon(Mt.noSessionIcon)}async raiseHandIcon(){this.raisedHand=true;await this.setIcon(Mt.handIcon)}async shareScreenIcon(){this.sharesScreen=true;await this.setIcon(Mt.dottedIcon)}async noShareScreenIcon(){this.sharesScreen=false;await this.setIcon(this.selectIcon())}async clearRaiseHandIcon(){this.raisedHand=false;await this.setIcon(this.selectIcon())}selectIcon(){if(this.active){if(this.raisedHand){return Mt.handIcon}else if(this.sharesScreen){return Mt.dottedIcon}return Mt.sessionIcon}return Mt.noSessionIcon}async setIcon(e){return new Promise((t=>{chrome.browserAction.setIcon({path:e},(()=>{t()}))}))}static markNotAuthorized(){chrome.browserAction.setBadgeText({text:"!"});chrome.browserAction.setBadgeBackgroundColor({color:"#F00"})}static clearBadge(){chrome.browserAction.setBadgeText({text:""})}}function Ht(){const e=Ae.isClassSessionActive;if(!Ae.tabListenersAdded&&e){chrome.tabs.onActivated.addListener(Vt);chrome.tabs.onCreated.addListener(Xt);chrome.tabs.onUpdated.addListener(Qt);chrome.tabs.onRemoved.addListener(Yt);Ae.tabListenersAdded=true}else if(Ae.tabListenersAdded&&!e){chrome.tabs.onActivated.removeListener(Vt);chrome.tabs.onCreated.removeListener(Xt);chrome.tabs.onUpdated.removeListener(Qt);chrome.tabs.onRemoved.removeListener(Yt);Ae.tabListenersAdded=false}}function qt(e){if(e>0){chrome.idle.setDetectionInterval(e*60);chrome.idle.onStateChanged.addListener(Dt)}else{chrome.idle.onStateChanged.removeListener(Dt)}}function Dt(e){const t={response:d,isIdle:e!=="active"};Le.sendCommand(t)}async function Wt(e){const t=await Me({});for(const s of t){try{await $t(s,"onApply",e);await ot(s.id,{muted:Ae.isScreenLocked})}catch(e){console.log("Error updating lock status: "+e)}}}function Bt(){if(Ae.isClassSessionActive){const e=(Ae.isScreenLocked||Ae.maximizeFocusedWindow)&&!chrome.windows.onFocusChanged.hasListener(Ft);const t=Ae.maximizeFocusedWindow&&!chrome.windows.onBoundsChanged.hasListener(zt);const s=Ae.isScreenLocked&&!chrome.windows.onRemoved.hasListener(Jt);if(e){chrome.windows.onFocusChanged.addListener(Ft)}if(t){chrome.windows.onBoundsChanged.addListener(zt);chrome.windows.onCreated.addListener(zt)}if(s){chrome.windows.onRemoved.addListener(Jt)}}else{chrome.windows.onFocusChanged.removeListener(Ft);chrome.windows.onRemoved.removeListener(Jt);chrome.windows.onBoundsChanged.removeListener(zt);chrome.windows.onCreated.removeListener(zt)}}async function Ft(e){if(Ae.maximizeFocusedWindow&&!Ae.isScreenLocked&&typeof e=="number"&&e!==chrome.windows.WINDOW_ID_NONE&&e!==Ae.blockWindowId){await Fe(e,{state:"maximized"});return}if(!Ae.isScreenLocked||!Ae.isChromeBook){return}if(!Ae.blockWindowId){const e=await De();if(!e){return}Ae.blockWindowId=e.id}if(typeof e=="undefined"||typeof e=="number"&&(e===chrome.windows.WINDOW_ID_NONE||e!==Ae.blockWindowId)){await Be(Ae.blockWindowId)}}async function Jt(e){if(!Ae.isScreenLocked){return}if(Ae.blockWindowId===e){setTimeout((async()=>{try{Ae.blockWindowId=await it();await Be(Ae.blockWindowId)}catch(e){console.log("Cannot make window fullscreen: "+e)}}),1e3)}}async function zt(e){if(e.type!=="normal"||e.id===Ae.blockWindowId||e.state==="fullscreen"){return}try{await Fe(e.id,{state:"maximized"})}catch(e){console.log("Cannot maximize window: "+e)}}async function jt(e){const t=await Me({});for(const s of t){try{await Zt(s,"onApply",e)}catch(e){console.log("Catched update chat state error for tab="+s.id+" '"+s.url+"': "+e)}}}async function Gt(e){if(Ae.maxOpenTabs>0){let t=await Me({});if(Ae.blockWindowId===e.windowId){return true}if(t.length>Ae.maxOpenTabs+Ae.additionalOpenTabs){if(typeof e.id!="undefined"){je(e.id)}else{console.log("Cannot close tab, no tab.id");return false}}}return true}function Vt(e){const t=e["tabId"];if(Ae.activeTabId==null){Ae.activeTabId=t;return}if(Ae.activeTabId!==t&&Ae.isChatActive){const e={command:"chatStatus",chat:true,forceCloseChat:true};et(Ae.activeTabId,e).then((()=>{console.log("Command to close chat in tabId="+Ae.activeTabId+" sent. New active tabId="+t);Ae.activeTabId=t})).catch((e=>{console.log("Error="+e+". Command to close chat in tabId="+Ae.activeTabId+" NOT sent. New active tabId="+t)}));if(Ae.hasUnreadChatMessages){const e={command:"chatStatus",chat:true,forceOpenChat:true};et(t,e).then((()=>{console.log("Command to open chat in tabId="+t+" sent.")})).catch((e=>{console.log("Error= "+e+". Command to open chat in tabId="+t+" NOT sent.")}))}}}async function Xt(e){const t="onCreate";if(e.url&&Ae.conferenceUrl===e.url){return}const s=await Gt(e);if(!s){console.log("Catched on tab create listener error: Tabs limit exceeded")}else if(Ae.isChatActive){return Zt(e,t)}}async function Qt(e,t,s){const n="onUpdate";if(t.status==="complete"){const e=await Gt(s);try{if(e&&Ae.isChatActive){await Zt(s,n)}if(e&&Ae.isScreenLocked){await $t(s,n)}}catch(e){console.log("Catched on tab update listener error: "+JSON.stringify(e))}}if(s.url){const t=Cs({url:s.url});if(t){try{await ot(e,{url:t})}catch(t){console.log("Error updating tab url: "+t);je(e)}}}}async function Yt(){if(Ae.additionalOpenTabs>0){Ae.additionalOpenTabs-=1}}async function $t(e,t,s){if(typeof e.status==="undefined"||typeof e.url==="undefined"){return}if(typeof e.id==="number"){if(!As(e.url,["https?:\\/\\/chrome\\.google\\.com\\/webstore\\/?.*?"],false)&&(Ae.isScreenLocked||Ae.whitelist||Ae.announce!==null)){je(e.id);return}let n=null;if(Ae.isScreenLocked){n=Ae.blockedText}else if(Ae.whitelist&&!As(e.url,Ae.whitelist,true)){n=Ae.isSiteLocked?"This site is not available during site lock":"This site is currently unavailable due to an active blocking plan"}else if(Ae.blockingPlanType===ce&&Ae.blockingPlanUrls&&!As(e.url,Ae.blockingPlanUrls,false)){n="This site is currently unavailable due to an active blocking plan"}const o=Ae.closeTabsTimeout!==null&&!s?true:null;const i={command:"lockStatus",announce:Ae.announce,announceTitle:"Announcement from"+(Ae.teacherName?": "+Ae.teacherName:" your teacher"),lock:n,tabsCloseWarning:o,messageType:t};try{await et(e.id,i)}catch(t){if(t.indexOf("chrome://")!==-1){je(e.id)}else{console.log("Lock not sent to tab '"+e.id+" {status:"+e.status+", discarded:"+e.discarded+"} "+e.title+"'. Error: "+t)}}}}async function Zt(e,t,s){if(typeof e.status==="undefined"||typeof e.url==="undefined"){return Promise.resolve()}return new Promise((async(n,o)=>{if(typeof e.id==="number"){const i={command:"chatStatus",messageType:t};if(Ae.isChatActive){i["chat"]=true;if(s){i["chatMessage"]=s}else if(Ae.hasUnreadChatMessages){i["chatMessage"]=Ae.chatMessages[Ae.chatMessages.length-1]}if(i["chatMessage"]&&e.highlighted){i["forceOpenChat"]=true}}else{i["chat"]=false}console.log("Send chat status message="+JSON.stringify(i)+" tabId="+e.id+" '"+e.url+"'");try{await et(e.id,i);n()}catch(e){o("Failed to send chat status:"+e)}}}))}async function Kt(e,t){if(!t){t=await Me({})}if(Ae.maxOpenTabs>0&&t&&t.length+e.length>=Ae.maxOpenTabs){Ae.additionalOpenTabs=t.length+e.length-Ae.maxOpenTabs}for(const t of e){try{await ze({url:t,active:true})}catch(e){console.log("Error while open sites: "+error)}}}async function es(e,t){if(!e||e.length===0){return Promise.resolve()}const s=e.map((e=>e.id));if(t){Ae.additionalOpenTabs=1;await ze({})}je(s)}async function ts(e){let t=await Me({});const s={command:"tabCloseWarning",delaySeconds:e};for(const e of t){if(typeof e.status==="undefined"||typeof e.url==="undefined"){return}if(typeof e.id==="number"){try{await et(e.id,s)}catch(e){console.log("Error while apply tabs close warning: "+e)}}}}async function ss(e,t,s=false){try{await Wt();let n;if(t){n=await Me({})}if(!s){const t=await He();if(!t||t.length===0){await We(e)}else{await Kt(e,n)}}if(t){await es(n,s)}}catch(e){console.log("Error while site lock: "+JSON.stringify(e))}}function ns(e){const t=/\/courses\/\d+\/assignments\/(\d+)/;const s=[];for(const n of e){const e=n.match(t);if(e&&e.length>1){s.push(e[1])}}return s}async function os(){const e=Ae.serverUrl+"/screenshare*";const t=await Me({url:e});for(const e of t){if(e.id){await je(e.id)}}}async function is(e){if(!Re){Re=new Mt}if(e&&e.length>0){await Re.activeClassIcon();cs(as(e))}else{await Re.noActiveClassIcon();cs()}}function as(e){return ve+"\n"+e.join(", ")+" class"+(e.length>1?"es":"")}function cs(e){const s={};if(typeof e!=="undefined"){s["title"]=e+"\n"+t}else{s["title"]=t}chrome.browserAction.setTitle(s)}function ls(e){const t=e?"popup.html":"";chrome.browserAction.setPopup({popup:t},(()=>{console.log("Popup set to "+(e?t:"none"))}))}function us(){const e=ds(true);Ae.announce=null;Ae.teacherId=null;Ht();Wt().then(Le.sendCommand(e))}function ds(e){return{response:H,isConfirmed:e,teacherId:Ae.teacherId}}function hs(e){if(e){chrome.runtime.onMessage.addListener(ms);console.log("MESSAGE LISTENER ADDED")}else{chrome.runtime.onMessage.removeListener(ms);console.log("MESSAGE LISTENER REMOVED")}}function ms(e,t,s){console.log("Got message from tab="+JSON.stringify(t.tab)+" Message="+JSON.stringify(e));const n=e["action"];switch(n){case"popup":return ws(e,t,s);case"notfound":ps(e,t,s);return true;case"teacherMessage":us();break;case"clearTabsCloseWarning":Ht();Wt(true);console.log("Tabs close warning cleared by student");s();break;case"respondToShareScreen":fs(e);break;case"chat":return ys(e,t,s);case"resizeLocked":Ft();break;case"getLockText":if(Ae.isScreenLocked){s(Ae.blockedText)}else{s(null)}break;case"call":s({token:Ae.conferenceToken,studentName:Ae.studentName});break;case"suspicious":s(null);if(t.tab.url&&t.tab.url.startsWith("about:")){console.log("Closing suspicious tab: "+JSON.stringify(t.tab));je(t.tab.id)}break;default:console.log("Received incorrect message in pageMessageListener="+JSON.stringify(e))}}function fs(e){Wt();const t=1024;const s=e["isConfirmed"];const n={response:P,userId:e["userId"],lock:e["lock"],isConfirmed:s};Le.sendCommand(n);if(s){const s=e["deviceId"];const n=Ae.serverUrl+"/agent/sharescreen/upload?did="+s;Ae.shareScreenHandler=setInterval(gs,4e3,n,t);Re.shareScreenIcon()}}async function gs(e,t){let s=false;if(!s){try{Ae.capturedScreen=await Ve()}catch(e){console.log("Cannot capture visible tab: "+e);return}const s=await _t(Ae.capturedScreen,t,t);const n=await Rt(e,s);if(!n){await Hs()}}else{console.log("Screenshot requested from native agent")}}function ws(e,t,s){let n=false;const o=e["popup"];switch(o){case"hello":Me({currentWindow:true,active:true}).then((e=>{if(e&&e.length>0){const t=e[0].url;if(t&&!t.toLowerCase().includes("newtab")){n=Ae.canStartChat||Ae.isChatActive}}})).catch((e=>{console.log("Error responding to popup="+e)})).finally((()=>{s({raiseHandEnabled:Ae.canRaiseHand,isHandRaised:Ae.isHandRaised,isSharingScreen:Ae.shareScreenHandler!==null,canStartChat:n})}));return true;case"handRaiseClick":Ae.isHandRaised=!Ae.isHandRaised;s({raiseHandEnabled:Ae.canRaiseHand,isHandRaised:Ae.isHandRaised});if(Ae.isHandRaised){Re.raiseHandIcon()}else{Re.clearRaiseHandIcon()}Le.sendCommand({response:u,isHandRaised:Ae.isHandRaised});break;case"startChatClick":s();Me({currentWindow:true,active:true}).then((e=>{if(e&&e.length>0){const t={command:"chatStatus",chat:true,forceOpenChat:true};et(e[0].id,t);console.log("Sent message to tabId="+e[0].id)}else{console.log("Cannot open chat from popup - no active tab")}}))}}async function ps(e,t,s){const n={reason:Ae.loginErrorReason};const directoryDeviceId=await $e();if(directoryDeviceId){n["directoryDeviceId"]=directoryDeviceId}const o=await Ze();if(o){n["serialNumber"]=o}s(n)}function ys(e,t,s){const n=e["command"];switch(n){case"getChatMessages":Ae.hasUnreadChatMessages=false;s({chatMessages:Ae.chatMessages});break;case"sendMessage":s();const t={sessionId:Ae.sessionId,text:e["text"],response:T};const n={date:(new Date).toUTCString(),isFromTeacher:false,text:e["text"]};Ae.chatMessages.push(n);Le.sendCommand(t).catch((e=>{console.log("Chat message send failed: "+JSON.stringify(e))}));break;default:s({chat:Ae.isChatActive,unread:Ae.hasUnreadChatMessages})}}function bs(e,t,s){chrome.notifications.clear(e,(function(n){chrome.notifications.create(e,{title:t,iconUrl:"logo48.png",type:"basic",message:s})}))}async function vs(){return new Promise((e=>{chrome.runtime.sendNativeMessage(Oe,{action:xe},(t=>{if(chrome.runtime.lastError){console.log("Error sending handshake to Windows agent V2: "+chrome.runtime.lastError.message);e(false)}e(t&&typeof t["version"]==="string")}))}))}function ks(e){if(!Ae){return{cancel:false}}const t=Cs(e);return t?{redirectUrl:t}:{cancel:false}}function Cs(e){const t=e.url;if(Is(t)){return null}let s=true;let n=chrome.runtime.getURL("blocking/block.html");if(Ae.whitelist&&!(Ae.lockedToCourseWorkResources&&Rs(e))){s=As(t,Ae.whitelist,true);n+=Ae.isSiteLocked?"?t=w":"?t="+btoa(encodeURIComponent(Ae.blockingPlanName))}else if(Ae.orgBlocklist||Ae.blockingPlanUrls&&!Ae.blockingPlanType===re){const e=Ae.orgBlocklist?As(t,Ae.orgBlocklist,false):true;const o=Ae.blockingPlanUrls?As(t,Ae.blockingPlanUrls,false):true;s=e&&o;if(!e){n+="?t=o"}else if(!o){n+="?t="+btoa(encodeURIComponent(Ae.blockingPlanName))}}if(!s){_s.saveUrl(new xt(t,null,true))}return s?null:n}function Is(e){for(const t of Ue){if(e.indexOf(t)!==-1){return true}}const t=e.match("^(.*[a-zA-Z]:\\/\\/)?([^\\/\\n]*)(\\/.*)?$");if(t&&t.length>1){const t=e.match("^(.*[a-zA-Z]:\\/\\/)?([^\\/\\n]*)(\\/.*)?$")[2];for(const e of Ee){if(t.includes(e)){return true}}}return false}function Ss(e){if(!Ae||!Ae.lockedToCourseWorkResources){return{cancel:false}}if(e.statusCode===302){const t=e.responseHeaders.find((e=>e.name.toLowerCase()==="location"));if(t&&As(e.url,Ae.whitelist,true)&&!Ae.whitelist.some((e=>t["value"]===e))){let e=t["value"];if(!e.includes("youtube.com")){e=e.split("?")[0]}Ae.whitelist.push(e);Ae.saveWhitelist(Ae.whitelist)}}return{cancel:false}}function Ts(e){if(!Ae.isObservationActive){return}if(e.url&&e.url.indexOf("chrome-extension")===-1){if(e.tabId!==-1){Es(e.tabId).then((t=>{_s.saveUrl(new xt(e.url,t))}))}else{_s.saveUrl(new xt(e.url,null))}}}async function Es(e,t=true){try{const s=await Je(e);if(s.title){return s.title}else if(t){await new Promise((e=>setTimeout(e,1e3)));return Es(e,false)}}catch(e){}return null}function Us(e){return e.match(/^([a-zA-Z]*:\/\/)?([wW]{3}[0-9]?\.)?([^\/\?]*)(\/|\?)?.*$/)[3]}function As(e,t,s){if(Ae.lockedToCourseWorkResources){for(const t of Ae.canvasAssignmentIds){if(e.includes("assignment_id="+t)){return s}}}if(!e.includes("youtube.com")){e=e.split("?")[0]}for(const n of t){if(e.match(n)){return s}}return!s}function Rs(e){const t=e.url?Us(e.url):null;for(const e of Se){if(t&&t.includes(e)){return true}}if(typeof e.initiator==="string"){const t=e.initiator;for(const e of Te){if(t.includes(e)){return true}}}return false}async function Ls(){if(navigator.onLine){if(!Ls.connecting){Ls.connecting=true;console.log("Connection restored");const e=await ct(ue);if(e){console.log("Restarting polling after connection restored");await lt(ue);wt()}}}else{Ls.connecting=false;console.log("Connection lost")}}var _s=null;chrome.webRequest.onBeforeRequest.addListener(ks,{urls:["<all_urls>"],types:["main_frame"]},["blocking"]);chrome.webRequest.onHeadersReceived.addListener(Ss,{urls:["<all_urls>"],types:["main_frame"]},["blocking","responseHeaders"]);chrome.webRequest.onCompleted.addListener(Ts,{urls:["<all_urls>"],types:["main_frame"]});console.log("Extension log here");navigator.connection.addEventListener("change",Ls);async function Ns(e){const t=e["tabId"];const s=e["requestType"];const n=e["userId"];je(t).then((()=>{Le.sendCommand({response:s,tabId:t,userId:n,isClosed:true})}))}async function Os(e){const t=e["tabId"];try{await Ge(t);Le.sendCommand({response:e["requestType"],tabId:t,userId:e["userId"]})}catch(e){console.log("Cannot focus tab: "+e)}}async function xs(e){Ae.chatMessages.push(e["chatMessage"]);Ae.hasUnreadChatMessages=true;Ht();try{await jt(e["chatMessage"]);if(Ae.playChatAlert){const e=new Audio("https://deviceconsole.securly.com/sound/chat.wav");await e.play()}}catch(e){console.log("Failed to update chat status on incoming message")}}async function Ps(e){const t=Ae.sessionId===(e.sessionId??null);const s=Ae.isObservationActive;Ae.updateClassSessionState(e);await is(Ae.activeClassNames);if(e["showNotifications"]&&s!==Ae.isObservationActive){if(Ae.isObservationActive){bs(ye,"Class session is active","Your device could be monitored and remotely managed by a teacher")}else{bs(ye,"No active class session","Your device is not monitored and cannot be remotely managed by a teacher")}}if(t){return}if(Ae.isObservationActive){await qs()}else{await bt()}if(Ae.shareScreenHandler){await Hs()}os();if(Ae.closeTabsTimeout!=null){clearTimeout(Ae.closeTabsTimeout);Ae.closeTabsTimeout=null}Ae.isHandRaised=false;await Re.clearRaiseHandIcon();ls(e["premium"]&&Ae.isClassSessionActive);Ht();hs(Ae.isClassSessionActive);qt(e["idleTimeout"]);await jt();await Wt();if(e["closeTabs"]){const t=parseInt(e["closeTabsWaitSeconds"]);if(typeof t==="number"&&t>0){await ts(t);Ae.closeTabsTimeout=setTimeout((async function(){console.log("Close tabs on session start after timeout");await es(await Me({}),!Ae.isChromeBook);Ae.closeTabsTimeout=null}),t*1e3)}else{console.log("Close tabs on session start");await es(await Me({}),!Ae.isChromeBook)}}else if(Ae.maxOpenTabs>0){const e=await Me({});if(e.length>Ae.maxOpenTabs){await es(e.slice(0,Ae.maxOpenTabs),!Ae.isChromeBook)}}Ae.conferenceUrl=null;if(Ae.maximizeFocusedWindow){const e=await De();if(e){try{await Fe(e.id,{state:"maximized"})}catch(e){console.log("Cannot maximize window: "+e)}}}Bt()}async function Ms(e){Ae.canRaiseHand=!!e["allowHandRaise"];Ae.isHandRaised=false;Ae.canStartChat=!!e["canStartChat"];Ae.playChatAlert=!!e["playChatAlertToStudent"];is(Ae.activeClassNames)}async function Hs(){clearInterval(Ae.shareScreenHandler);Ae.capturedScreen=null;Ae.shareScreenHandler=null;await Re.noShareScreenIcon();bs(be,"Screen sharing ended","Your teacher has stopped sharing your screen")}async function qs(){let e=await Me({lastFocusedWindow:true,active:true});if(!e||!e.length>0){e=await Me({active:true});if(!e||!e[0]||!e[0].url){return}}const t=e[0];if(!t.url||t.url.indexOf("chrome-extension")!==-1){return}_s.saveUrl(new xt(t.url,t.title))}async function Ds(){Ae.isHandRaised=false;Re.clearRaiseHandIcon()}async function Ws(e){const t=e["url"];const s=e["lockToSession"];if(!t&&Ae.conferenceUrl!==null){await Ae.clearWhitelist();Ht();await Wt();Ae.conferenceUrl=null;return}if(Ae.conferenceUrl!==t){Ae.conferenceUrl=t}try{if(Ae.maxOpenTabs>0){const e=await Me({});if(e&&e.length>=Ae.maxOpenTabs){Ae.additionalOpenTabs=e.length-Ae.maxOpenTabs+1}}await ze({url:t});if(s){const e=[Bs(t)];await Ae.saveBlockedInfo(null,ae);await Ae.saveWhitelist(e);Ht();await Wt()}}catch(e){console.log("Cannot open tab for conference. Error="+e)}}function Bs(e){return e.replace(/[/\-\\^$*+?.()|[\]{}]/g,"\\$&")}async function Fs(e){let t=null;const s=await Me({lastFocusedWindow:true,active:true});if(s.length>0){t=s[0]}const n=await Me({});console.log("Got "+n.length+" tabs");let o=[];let i=-1;n.forEach((function(e,s){const n={id:e.id,url:e.url,title:e.title};if(t!=null&&e.id===t.id){i=s}o.push(n)}));if(i!==-1){o.splice(0,0,o.splice(i,1)[0])}Le.sendCommand({isAppListRequested:false,response:e["requestType"],tabs:o,userId:e["userId"]})}async function Js(e){console.log("Lock screen requested and confirmed");await Ae.clearWhitelist();await Ae.saveBlockedInfo(e["screenBlockMessage"],ie);Ht();Bt();try{Ae.blockWindowId=await it();await Be(Ae.blockWindowId)}catch(e){console.log("Cannot create lock window: "+e)}await Wt()}async function zs(){console.log("Unlock requested and confirmed");await Ae.saveBlockedInfo(null,ae);await Ae.clearWhitelist();Ae.canvasAssignmentIds=[];Ht();Bt();if(Ae.blockWindowId!==0){try{await at(Ae.blockWindowId)}catch(e){console.log("Error while closing block window: "+e)}}await Wt()}async function js(e){Ae.announce=e["teacherMessage"];Ae.teacherName=e["teacherName"];Ae.teacherId=e["teacherId"];Ht();await Wt();Le.sendCommand(ds(false))}async function Gs(e){console.log("Got blocking plan");const t=e["orgBlocklist"];const s=e["blockingPlanUrls"];const n=e["blockingPlanName"];const o=e["blockType"];await Ae.clearWhitelist();await Ae.saveOrgBlocklist(t);await Ae.saveBlockingPlan(s,n,o);Ht();await Wt(false)}async function Vs(e){console.log("Got open site command");const t=e["urls"];const s=await He();if(!s||s.length===0){await We(t)}else{await Kt(t)}}async function Xs(e){if(e["deviceId"]){console.log("Got screen share request");Ht();const t={command:"requestShareScreen",userId:e["userId"],deviceId:e["deviceId"],lock:e["lock"]};const s=await Me({});for(const e of s){if(typeof e.id==="number"){try{await et(e.id,t)}catch(e){console.log("Error while requesting screen share: "+e)}}}}else{await Hs()}}async function Qs(e){console.log("Got site lock command");await Ae.saveBlockedInfo(null,ae);await Ae.saveWhitelist(e["whitelistPatterns"]);Ae.lockedToCourseWorkResources=!!e["courseWorkResources"];if(Ae.lockedToCourseWorkResources){Ae.canvasAssignmentIds=ns(e["urls"])}Ht();await ss(e["urls"],e["closeTabs"],e["notOpenTabs"])}async function Ys(){return new Promise((async e=>{console.log("Needs update check. Current version="+t);if(Ae.updateCheckDate.getTime()<(new Date).getTime()){console.log("Checking for extension update");const e=new Date;const t=10;e.setTime(e.getTime()+t*60*1e3);await Ae.saveUpdateCheckDate(e);chrome.runtime.requestUpdateCheck((async e=>{console.log("Update check status: "+e);switch(e){case ke:console.log("Extension update available, will reload");chrome.runtime.reload();break;case Ce:const e=new Date;e.setTime(e.getTime()+60*60*1e3);console.log("Update check is throttled. Next check time is "+e);await Ae.saveUpdateCheckDate(e);$s(60);break;default:$s(t)}}))}else{console.log("Next update check time is "+Ae.updateCheckDate);$s()}e()}))}function $s(e){if(!e){e=5}chrome.alarms.create(de,{delayInMinutes:e});console.log("Schedule app restart in "+e+" minutes")}const Zs=async function(e){rt().then((t=>{const s={response:e["requestType"]};Le.sendCommand(Object.assign(s,t))})).catch((e=>{console.log("Failed to get location: "+e)}))};async function Ks(e){const t=e["udid"];console.log("DeviceUdid set to: "+t);if(!_e){Mt.clearBadge()}await Ae.saveDeviceUdid(t)}async function en(e){if(typeof updateContactAdminButtonVisibility=="function"){updateContactAdminButtonVisibility(false)}else{Mt.markNotAuthorized()}Ae.loginErrorReason=e["reason"];await Ae.saveDeviceUdid(null);if(Ne){chrome.runtime.onMessage.addListener(ms);console.log("MESSAGE LISTENER ADDED");chrome.browserAction.onClicked.addListener(Ct)}await Ke();throw W}async function tn(e){if(typeof updateDeviceInfo==="function"){updateDeviceInfo(Ae.deviceUdid,e["deviceName"])}await Ae.saveDeviceName(e["deviceName"])}async function sn(e){await Ae.saveServerUrl(e["serverUrl"]);Le.updateUrl(e["serverUrl"])}async function nn(e){const t=e["shouldSendLogs"];if(typeof un!=="undefined"){un.logEnabled=t}if(t){chrome.alarms.create(me,{periodInMinutes:5})}else{chrome.alarms.clear(me)}console.log("Logging updated to "+t+" at "+new Date)}async function on(e){if(Ne){Ae.studentId=e["studentId"];Ae.studentName=e["studentName"]}if(_e){const t=e[Z];const s=e[X];const n=e[J];const o=e[K];const i=e[$];const a=e[Q];const r=e[Y];await Ae.saveDeviceInfo(t,s,n,o,i,a,r);updateOrgAndScreen();updateContactAdminButtonVisibility(Ae.isContactAdminAllowed===true);updateDeviceInfo(Ae.deviceUdid,s)}Ae.isLoggedIn=true;console.log("Complete login routine. Screen "+(Ae.isScreenLocked?"is locked with text '"+Ae.blockedText+"'":" is not locked"))}async function an(e){const t={seq:e["seq"],response:m,modeType:e["modeType"]};if(_e){console.log("Enable lost mode requested and confirmed");requestBlockScreen(e[K],e[J],e[$],e[Y],e["allowContactAdmin"]);updateDeviceInfo(Ae.deviceUdid,Ae.deviceName);updateSyncDate();await Ae.saveBlockedInfo(e[K],e[J],e[$],e[Y],e[Q])}return t}async function rn(e){cn(e)}async function cn(e){console.log("Screenshot requested");const t=await Me({currentWindow:true,active:true});if(t.length>0){const s=t[0].url;const n=t[0].title;try{const t=Ae.capturedScreen!==null?Ae.capturedScreen:await Ve();if(typeof s!=="undefined"){e["tabUrl"]=s}if(typeof n!=="undefined"){e["tabTitle"]=n}At(t,e)}catch(e){console.log("Error capture visible tab: "+e)}}else{console.log("No tabs found to capture")}}Ie[w]=Ks;Ie[p]=tn;Ie[y]=sn;Ie[b]=en;Ie[v]=Zs;Ie[C]=nn;Ie[k]=on;Ie[x]=rn;Ie[S]=Gs;Ie[T]=xs;Ie[E]=Ps;Ie[U]=Ms;Ie[A]=Ds;Ie[R]=Ns;Ie[L]=Os;Ie[_]=Fs;Ie[N]=Js;Ie[O]=Vs;Ie[P]=Xs;Ie[M]=Qs;Ie[H]=js;Ie[D]=zs;Ie[q]=Ws;st();const ln=console.log;function un(e){if(typeof ln==="function"){ln.apply(this,arguments)}if(un.logEnabled){const t="/agent/chrome/debug";const s=new XMLHttpRequest;s.timeout=we;s.ontimeout=function(){ln.apply(null,["Timeout while sending logs to the server"])};if(Ae){const n=Ae.deviceUdid?Ae.deviceUdid:Ae.directoryDeviceId;const o=Ae.serverUrl+t;s.open("POST",o);s.setRequestHeader(ge,n);s.setRequestHeader("Content-Type","application/json; charset=UTF-8");const i={udid:n,logNum:un.logCount,logString:e,logSource:"extension"};un.logCount+=1;s.send(JSON.stringify(i))}}}console.log=un;un.logEnabled=true;un.logCount=0;